<!DOCTYPE html>
<html lang="en">
<body>
<button id="start">Start</button>
<script>
const SAMPLE_RATE = 22050;
const ctx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
let ws;
let textWs;
let heardWs;
let lookWs;
let lookVideo;
let lookCanvas;
let queue = [];
let texts = [];
let playing = false;

function openSocket(existing, url, binaryType) {
  if (existing && existing.readyState <= WebSocket.OPEN) return existing;
  const s = new WebSocket(url);
  if (binaryType) s.binaryType = binaryType;
  return s;
}

function segmentDone() {
  const text = texts.shift();
  if (heardWs && text) heardWs.send(text);
}

function play() {
  if (playing || !queue.length) return;
  playing = true;
  const pcm = queue.shift();
  if (pcm.length === 0) {
    playing = false;
    segmentDone();
    play();
    return;
  }
  const buf = ctx.createBuffer(1, pcm.length, SAMPLE_RATE);
  const chan = buf.getChannelData(0);
  for (let i = 0; i < pcm.length; i++) chan[i] = pcm[i] / 32768;
  const src = ctx.createBufferSource();
  src.buffer = buf;
  src.connect(ctx.destination);
  src.onended = () => { playing = false; play(); };
  src.start();
}

function start() {
  ws = openSocket(ws, `ws://${location.host}/ws/audio/out`, 'arraybuffer');
  if (ws.readyState <= WebSocket.OPEN) {
    ws.onmessage = ev => {
      queue.push(new Int16Array(ev.data));
      if (ctx.state === 'suspended') ctx.resume();
      play();
    };
  }
  textWs = openSocket(textWs, `ws://${location.host}/ws/audio/text/out`);
  if (textWs.readyState <= WebSocket.OPEN)
    textWs.onmessage = ev => texts.push(ev.data);
  heardWs = openSocket(heardWs, `ws://${location.host}/ws/audio/self/in`);
  lookWs = openSocket(lookWs, `ws://${location.host}/ws/look/in`, 'arraybuffer');
  if (lookWs.readyState <= WebSocket.OPEN)
    lookWs.onmessage = ev => {
      if (ev.data === 'snap') capture();
    };
  navigator.mediaDevices.getUserMedia({ video: true }).then(s => {
    lookVideo = document.createElement('video');
    lookVideo.srcObject = s;
    lookVideo.play();
    lookCanvas = document.createElement('canvas');
  });
  document.getElementById('start').style.display = 'none';
}

function capture() {
  if (!lookVideo) return;
  lookCanvas.width = lookVideo.videoWidth;
  lookCanvas.height = lookVideo.videoHeight;
  const ctx2d = lookCanvas.getContext('2d');
  ctx2d.drawImage(lookVideo, 0, 0);
  lookCanvas.toBlob(b => b && b.arrayBuffer().then(buf => lookWs.send(buf)), 'image/jpeg', 0.8);
}

// Attach the start handler only once so we don't open duplicate WebSocket
// connections if the user clicks multiple times.
document
  .getElementById('start')
  .addEventListener('click', start, { once: true });
</script>
</body>
</html>
